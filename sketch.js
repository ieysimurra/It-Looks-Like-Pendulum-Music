let instructions_en_content = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Playground Instructions</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            color: #333;
        }
        a {
            color: #007acc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<h1 class="code-line" data-line-start=0 data-line-end=1 ><a id="_Welcome_to_the_World_of_Nested_Pendulums__0"></a>ğŸ¨ Welcome to the World of Nested Pendulums! ğŸ¶</h1>
<p class="has-line-data" data-line-start="1" data-line-end="2">Get ready to explore the mesmerizing dance of double pendulums and their hypnotic sounds, inspired by Steve Reichâ€™s Pendulum Music! Learn more about the inspiration <a href="https://en.wikipedia.org/wiki/Pendulum_Music">here</a>. If youâ€™d like an audiovisual example, you can find more information <a href="https://youtu.be/fU6qDeJPT-w?si=R3zjwq8b7ommv3eI">here</a>. Below are simple steps to guide you on how to interact with this playful and creative sketch. Letâ€™s dive in! ğŸŒŠ</p>
<hr>
<h2 class="code-line" data-line-start=4 data-line-end=5 ><a id="_Add_Your_Own_Pendulum_4"></a>â• Add Your Own Pendulum</h2>
<p class="has-line-data" data-line-start="5" data-line-end="7"><strong>Step 1</strong>:<br>
Click the â€œAdd Pendulumâ€ button on the right side of your screen to introduce a new pendulum into the scene. Each pendulum brings its unique sound into the mix, so feel free to experiment with different combinations!</p>
<hr>
<h2 class="code-line" data-line-start=8 data-line-end=9 ><a id="_Adjust_the_Controls_8"></a>ğŸ›ï¸ Adjust the Controls</h2>
<p class="has-line-data" data-line-start="9" data-line-end="11"><strong>Step 2</strong>:<br>
Use the sliders on the left side to customize your pendulum. You can control the angles, lengths, masses, and even the colors of your pendulums! Donâ€™t forget to tweak the gravity and amplitude sliders to see how they affect the movement and sound.</p>
<p class="has-line-data" data-line-start="12" data-line-end="18"><strong>Angle Sliders</strong> ğŸ¯: Adjust the initial angles of the pendulums.<br>
<strong>Length Sliders</strong> ğŸ“: Control the lengths of the pendulum arms.<br>
<strong>Mass Sliders</strong> âš–ï¸: Change the mass of each pendulum bob.<br>
<strong>Color Sliders</strong> ğŸŒˆ: Play with the red and blue sliders to change the bob colors.<br>
<strong>Gravity Slider</strong> ğŸŒ: Set the gravitational pull on the pendulums.<br>
<strong>Amplitude Slider</strong> ğŸ”Š: Adjust the sound intensity.</p>
<hr>
<h2 class="code-line" data-line-start=19 data-line-end=20 ><a id="_ShowHide_Controls_19"></a>ğŸ‘ï¸ Show/Hide Controls</h2>
<p class="has-line-data" data-line-start="20" data-line-end="22"><strong>Step 3</strong>:<br>
Need a cleaner view? Use the â€œShow/Hide Controlsâ€ button to toggle the visibility of the sliders. Hide them to focus on the pendulumsâ€™ movements or show them again to make adjustments.</p>
<hr>
<h2 class="code-line" data-line-start=23 data-line-end=24 ><a id="_Zoom_In__Out_23"></a>ğŸ” Zoom In &amp; Out</h2>
<p class="has-line-data" data-line-start="24" data-line-end="26"><strong>Step 4</strong>:<br>
Bring the pendulums closer or view the entire scene by using the â€œZoom Inâ€ and â€œZoom Outâ€ buttons. Adjust the perspective to suit your creative vision!</p>
<hr>
<h2 class="code-line" data-line-start=27 data-line-end=28 ><a id="_Remove_the_Oldest_Pendulum_27"></a>âŒ Remove the Oldest Pendulum</h2>
<p class="has-line-data" data-line-start="28" data-line-end="30"><strong>Step 5</strong>:<br>
Is the scene getting too crowded? Remove the oldest pendulum by clicking the â€œRemove Pendulumâ€ button. The earliest pendulum will gracefully exit the stage, leaving space for new ones.</p>
<hr>
<h2 class="code-line" data-line-start=31 data-line-end=32 ><a id="_Record_Your_Masterpiece_31"></a>ğŸ¥ Record Your Masterpiece</h2>
<p class="has-line-data" data-line-start="32" data-line-end="34"><strong>Step 6</strong>:<br>
Capture your creation by clicking â€œStart Video Recordâ€ to begin recording the pendulum movements and their corresponding sounds. Click the button again to stop recording and save your masterpiece.</p>
<hr>
<h2 class="code-line" data-line-start=35 data-line-end=36 ><a id="_Record_the_Soundtrack_35"></a>ğŸ¤ Record the Soundtrack</h2>
<p class="has-line-data" data-line-start="36" data-line-end="38"><strong>Step 7</strong>:<br>
Prefer just the audio? Use the â€œStart Audio Recordâ€ button to record the audio only. Play around with the pendulums to create your unique soundscape, then save it for later listening.</p>
<hr>
<h2 class="code-line" data-line-start=39 data-line-end=40 ><a id="_Reset_and_Start_Over_39"></a>ğŸ”„ Reset and Start Over</h2>
<p class="has-line-data" data-line-start="40" data-line-end="42"><strong>Step 8</strong>:<br>
Want to start fresh? Click â€œReset Sketchâ€ to clear everything and begin anew. Your creativity knows no bounds!</p>
<hr>
<h3 class="code-line" data-line-start=43 data-line-end=44 ><a id="Enjoy_your_journey_into_the_rhythmic_world_of_nested_pendulums_Experiment_play_and_let_your_imagination_flow_as_you_create_captivating_visuals_and_sounds__43"></a>Enjoy your journey into the rhythmic world of nested pendulums! Experiment, play, and let your imagination flow as you create captivating visuals and sounds. ğŸ¶âœ¨</h3>
  
</body>
</html>
`;

let instructions_pt_content = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Playground Instructions</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            color: #333;
        }
        a {
            color: #007acc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<h1 class="code-line" data-line-start=0 data-line-end=1 ><a id="_Bemvindo_ao_Mundo_dos_Pndulos_Aninhados__0"></a>ğŸ¨ Bem-vindo ao Mundo dos PÃªndulos Aninhados! ğŸ¶</h1>
<p class="has-line-data" data-line-start="1" data-line-end="2">Prepare-se para explorar a danÃ§a hipnotizante dos pÃªndulos duplos e seus sons hipnÃ³ticos, inspirados pela MÃºsica de PÃªndulo de Steve Reich! Saiba mais sobre a inspiraÃ§Ã£o <a href="https://en.wikipedia.org/wiki/Pendulum_Music">aqui</a>. Se vocÃª quiser um exemplo audiovisual, pode encontrar mais informaÃ§Ãµes <a href="https://youtu.be/fU6qDeJPT-w?si=R3zjwq8b7ommv3eI">aqui</a>. Abaixo estÃ£o os passos simples para orientÃ¡-lo sobre como interagir com este esboÃ§o lÃºdico e criativo. Vamos mergulhar! ğŸŒŠ</p>
<hr>
<h2 class="code-line" data-line-start=4 data-line-end=5 ><a id="_Adicione_seu_prprio_pndulo_4"></a>â• Adicione seu prÃ³prio pÃªndulo</h2>
<p class="has-line-data" data-line-start="5" data-line-end="7"><strong>Etapa 1</strong>:<br>
Clique no botÃ£o <strong><em>Add Pendulum</em></strong> no lado direito da tela para introduzir um novo pÃªndulo na cena. Cada pÃªndulo traz seu som Ãºnico para a mistura, entÃ£o sinta-se Ã  vontade para experimentar diferentes combinaÃ§Ãµes!</p>
<hr>
<h2 class="code-line" data-line-start=8 data-line-end=9 ><a id="_Ajuste_os_controles_8"></a>ğŸ›ï¸ Ajuste os controles</h2>
<p class="has-line-data" data-line-start="9" data-line-end="11"><strong>Etapa 2</strong>:<br>
Use os controles deslizantes no lado esquerdo para personalizar seu pÃªndulo. VocÃª pode controlar os Ã¢ngulos, comprimentos, massas e atÃ© mesmo as cores dos seus pÃªndulos! NÃ£o se esqueÃ§a de ajustar os controles deslizantes de gravidade e amplitude para ver como eles afetam o movimento e o som.</p>
<p class="has-line-data" data-line-start="12" data-line-end="18"><strong><em>Angle Sliders</em></strong> ğŸ¯: ajuste os Ã¢ngulos iniciais dos pÃªndulos.<br>
<strong><em>Length Sliders</em></strong> ğŸ“: controle os comprimentos dos braÃ§os do pÃªndulo.<br>
<strong><em>Mass Sliders</em></strong> âš–ï¸: altere a massa de cada pÃªndulo.<br>
<strong><em>Color Sliders</em></strong> ğŸŒˆ: brinque com os controles deslizantes vermelho e azul para alterar as cores do pÃªndulo.<br>
<strong><em>Gravity Slider</em></strong> ğŸŒ: defina a atraÃ§Ã£o gravitacional nos pÃªndulos.<br>
<strong><em>Amplitude Slider</em></strong> ğŸ”Š: ajuste a intensidade do som.</p>
<hr>
<h2 class="code-line" data-line-start=19 data-line-end=20 ><a id="_Mostrarocultar_controles_19"></a>ğŸ‘ï¸ Mostrar/ocultar controles</h2>
<p class="has-line-data" data-line-start="20" data-line-end="22"><strong>Etapa 3</strong>:<br>
Precisa de uma visÃ£o mais limpa? Use o botÃ£o <strong><em>Show/Hide Controls</em></strong> para alternar a visibilidade dos controles deslizantes. Oculte-os para focar nos movimentos dos pÃªndulos ou mostre-os novamente para fazer ajustes.</p>
<hr>
<h2 class="code-line" data-line-start=23 data-line-end=24 ><a id="_Ampliar_e_Reduzir_23"></a>ğŸ” Ampliar e Reduzir</h2>
<p class="has-line-data" data-line-start="24" data-line-end="26"><strong>Etapa 4</strong>:<br>
Aproxime os pÃªndulos ou visualize a cena inteira usando os botÃµes <strong><em>Zoom In</em></strong> e <strong><em>Zoom Out</em></strong>. Ajuste a perspectiva para se adequar Ã  sua visÃ£o criativa!</p>
<hr>
<h2 class="code-line" data-line-start=27 data-line-end=28 ><a id="_Remova_o_pndulo_mais_antigo_27"></a>âŒ Remova o pÃªndulo mais antigo</h2>
<p class="has-line-data" data-line-start="28" data-line-end="30"><strong>Etapa 5</strong>:<br>
A cena estÃ¡ ficando muito cheia? Remova o pÃªndulo mais antigo clicando no botÃ£o <strong><em>Remove Pendulum</em></strong>. O pÃªndulo mais antigo sairÃ¡ graciosamente do palco, deixando espaÃ§o para os novos.</p>
<hr>
<h2 class="code-line" data-line-start=31 data-line-end=32 ><a id="_Grave_sua_obraprima_31"></a>ğŸ¥ Grave sua obra-prima</h2>
<p class="has-line-data" data-line-start="32" data-line-end="34"><strong>Etapa 6</strong>:<br>
Capture sua criaÃ§Ã£o clicando em <strong><em>Start Video Record</em></strong> movimentos do pÃªndulo e seus sons correspondentes. Clique no botÃ£o novamente para interromper a gravaÃ§Ã£o e salvar sua obra-prima.</p>
<hr>
<h2 class="code-line" data-line-start=35 data-line-end=36 ><a id="_Grave_a_trilha_sonora_35"></a>ğŸ¤ Grave a trilha sonora</h2>
<p class="has-line-data" data-line-start="36" data-line-end="38"><strong>Etapa 7</strong>:<br>
Prefere apenas o Ã¡udio? Use o botÃ£o <strong><em>Start Audio Record</em></strong> para gravar apenas o Ã¡udio. Brinque com os pÃªndulos para criar sua paisagem sonora Ãºnica e salve-a para ouvir mais tarde.</p>
<hr>
<h2 class="code-line" data-line-start=39 data-line-end=40 ><a id="_Reiniciar_e_recomear_39"></a>ğŸ”„ Reiniciar e recomeÃ§ar</h2>
<p class="has-line-data" data-line-start="40" data-line-end="42"><strong>Etapa 8</strong>:<br>
Quer comeÃ§ar do zero? Clique em <strong><em>Reset Sketch</em></strong> para limpar tudo e comeÃ§ar de novo. Sua criatividade nÃ£o tem limites!</p>
<hr>
<h3 class="code-line" data-line-start=43 data-line-end=44 ><a id="Aproveite_sua_jornada_no_mundo_rtmico_dos_pndulos_aninhados_Experimente_brinque_e_deixe_sua_imaginao_fluir_enquanto_cria_visuais_e_sons_cativantes__43"></a>Aproveite sua jornada no mundo rÃ­tmico dos pÃªndulos aninhados! Experimente, brinque e deixe sua imaginaÃ§Ã£o fluir enquanto cria visuais e sons cativantes. ğŸ¶âœ¨</h3>
  
</body>
</html>
`;


let currentLanguage = 'en'; // Default language

let pendulums = [];
let gravity = 1.0;
let maxPendulums = 5;
let zoom = 1;
let offsetX = 0;
let offsetY = 0;
let dragging = false;

let angle1Slider, angle2Slider, length1Slider, length2Slider, mass1Slider, mass2Slider, gravitySlider;
let r1Slider, g1Slider, b1Slider, r2Slider, g2Slider, b2Slider;
let amplitudeSlider; // New amplitude slider
let slidersHidden = false; // Flag to indicate if sliders are hidden

let panPosition1, panPosition2;
// In the setup() function or as global variables
let freqRange1 = [50, 5000]; // Define your valid frequency range for arm1 here (adjust the values as needed)
let freqRange2 = [50, 5000]; // Define your valid frequency range for arm2 here (adjust the values as needed)

let mediaRecorder;
let chunks = [];
let recordingButton, stopRecordingButton;

let canvas;
let isRecording = false; // New global variable to track the recording state

let isAudioRecording = false; // Variable to track the audio recording state
let audioRecordingButton;
let audioChunks = []; // Array to store audio data chunks
let audioRecorder;

let areControlsShown = true;  // Assuming controls are shown by default


let pendulumLog = [];

function setup() {
  createCanvas(windowWidth, windowHeight);
  canvas = createCanvas(windowWidth, windowHeight);

let maxLength = min(width, height) * 0.3;  // The maximum length is half of the smaller dimension of the window

// Create GUI controls
createButton('Add Pendulum').position(windowWidth - 110, 10).mousePressed(addPendulum);
createButton('Zoom In').position(windowWidth - 110, 40).mousePressed(zoomIn);
createButton('Zoom Out').position(windowWidth - 110, 70).mousePressed(zoomOut);
createButton('Show/hide Controls').position(windowWidth - 110, 100).mousePressed(toggleSliders); // Button to toggle sliders visibility
 // Create the reset button
createButton('Reset Sketch').position(windowWidth - 110, 143).mousePressed(resetSketch);  
createButton('Remove Pendulum').position(windowWidth - 110, 170).mousePressed(removePendulum);

  
  // Function to reset the sketch
  function resetSketch() {
    // Reload the page to reset the sketch
    window.location.reload();
  }  
  
function removePendulum() {
  if (pendulums.length > 0) {
    // Remove the first pendulum from the array
    pendulums.shift();
  }
}  

createP().position(10, 10);
angle1Slider = createSlider(0, TWO_PI, PI / 4, 0.01).position(10, 20);
createP().position(10, 40);
angle2Slider = createSlider(0, TWO_PI, PI / 4, 0.01).position(10, 60);
createP().position(10, 70);
length1Slider = createSlider(height * 0.1,  maxLength, 100, 1).position(10, 100);
createP().position(10, 110);
length2Slider = createSlider(height * 0.1,  maxLength, 100, 1).position(10, 140);
createP().position(10, 140);
mass1Slider = createSlider(5, 50, 15, 0.1).position(10, 180);
createP().position(10, 170);
mass2Slider = createSlider(5, 50, 15, 0.1).position(10, 220);
createP().position(10, 210);
gravitySlider = createSlider(-10.0, 10.0, 1.0, 0.1).position(10, 260);

r1Slider = createSlider(1, 255, 127).position(10, 300).style('color','red');
b1Slider = createSlider(1, 255, 127).position(10, 340).style('color','blue');

r2Slider = createSlider(1, 255, 127).position(10, 380).style('color','red');
b2Slider = createSlider(1, 255, 127).position(10, 420).style('color','blue');

  // Create the amplitude slider
amplitudeSlider = createSlider(0.01, 1, 0.5, 0.01).position(10, 460);

    // Create a single button for recording
    recordingButton = createButton('Start Video Record');
    recordingButton.position(windowWidth - 110, 213);
    recordingButton.mousePressed(toggleRecording);
  
      // Create a single button for audio recording
    audioRecordingButton = createButton('Start Audio Record');
    audioRecordingButton.position(windowWidth - 110, 290); // Adjust position as needed
    audioRecordingButton.mousePressed(toggleAudioRecording);
  
    let instructionButton = createButton('Instructions');
    instructionButton.position(0, windowHeight - 25);
    instructionButton.mousePressed(() => openInstructionPopup(instructionButton));
}

function openInstructionPopup(instructionButton) {
  let content;
  if (currentLanguage === 'en') {
    content = instructions_en_content;
    currentLanguage = 'pt';
    instructionButton.html('InstruÃ§Ãµes');
  } else if (currentLanguage === 'pt') {
    content = instructions_pt_content;
    currentLanguage = 'en';
    instructionButton.html('Instructions');
  }
  showInstructions(content);
}

function showInstructions(content) {
  // Cria uma sobreposiÃ§Ã£o cobrindo toda a tela
  let overlay = createDiv();
  overlay.id('instruction-overlay');
  overlay.position(0, 0);
  overlay.size(windowWidth, windowHeight);
  overlay.style('background-color', 'rgba(0, 0, 0, 0.8)');
  overlay.style('display', 'flex');
  overlay.style('align-items', 'center');
  overlay.style('justify-content', 'center');
  overlay.style('z-index', '1000'); // Certifique-se de que a sobreposiÃ§Ã£o fique acima de outros elementos

  // Cria um contÃªiner para o conteÃºdo das instruÃ§Ãµes
  let contentDiv = createDiv(content);
  contentDiv.parent(overlay);
  contentDiv.style('background-color', 'white');
  contentDiv.style('padding', '20px');
  contentDiv.style('max-width', '80%');
  contentDiv.style('max-height', '80%');
  contentDiv.style('overflow', 'auto');
  contentDiv.style('position', 'relative');

  // BotÃ£o para fechar a sobreposiÃ§Ã£o
  let closeButton = createButton('Fechar');
  closeButton.parent(contentDiv);
  closeButton.style('position', 'absolute');
  closeButton.style('top', '10px');
  closeButton.style('right', '10px');
  closeButton.mousePressed(() => overlay.remove());
}

function toggleRecording() {
    if (isRecording) {
        stopRecording();
        recordingButton.html('Start Video Record');
        recordingButton.style('background-color', '');  // Set to default color when not recording
    } else {
        startRecording();
        recordingButton.html('Stop Video Record');
        recordingButton.style('background-color', '#FF5733');  // Highlight when recording
    }
    isRecording = !isRecording;
}

function startRecording() {
    // Get the stream from canvas for video
    let canvasStream = canvas.canvas.captureStream(30);  // 30 FPS

    // For the audio stream using Tone.js
    let dest = Tone.context.createMediaStreamDestination();
    Tone.Master.connect(dest);
    let audioStream = dest.stream;

    // Combine video and audio streams
    let tracks = [...canvasStream.getTracks(), ...audioStream.getTracks()];
    let combinedStream = new MediaStream(tracks);
    mediaRecorder = new MediaRecorder(combinedStream);

    mediaRecorder.ondataavailable = (event) => {
        chunks.push(event.data);
    };

    mediaRecorder.onstop = (event) => {
        const blob = new Blob(chunks, { type: "video/webm" });
        chunks = [];
        const videoURL = window.URL.createObjectURL(blob);
        const downloadLink = createA(videoURL, 'Download Recording', '_blank');
        downloadLink.download = 'pendulum_interaction.webm';
        downloadLink.position(windowWidth - 110, 250);
      
      let anchor = document.createElement('a');
      anchor.href = window.URL.createObjectURL(blob);
      anchor.download = 'recording.webm';
      anchor.click();

    };

    mediaRecorder.start();
  
    // Change the button's background color when recording starts
    recordingButton.style('background-color', '#FF5733');  // Change to your desired color
  
}

function stopRecording() {
    if (mediaRecorder) {
        mediaRecorder.stop();
    }
      // Revert the button's background color when recording stops
    recordingButton.style('background-color', '');  // Removes the inline style, reverting it to its original state or CSS style

  saveLogData();
}

function toggleAudioRecording() {
    if (isAudioRecording) {
        stopAudioRecording();
        audioRecordingButton.html('Start Audio Record');
    } else {
        startAudioRecording();
        audioRecordingButton.html('Stop Audio Record');
    }
    isAudioRecording = !isAudioRecording;
}

function startAudioRecording() {
    let dest = Tone.context.createMediaStreamDestination();
    Tone.Master.connect(dest);
    let audioStream = dest.stream;

    audioRecorder = new MediaRecorder(audioStream);

    audioRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
    };
  
  audioRecorder.onstop = (event) => {

      const blob = new Blob(audioChunks, { type: "audio/webm" });
      audioChunks = [];
      const audioURL = window.URL.createObjectURL(blob);  
      const downloadLink = createA(audioURL, 'Download Audio', '_blank');
      downloadLink.download = 'audio_recording.webm';  
      downloadLink.position(windowWidth - 110, 330); // Adjust position as needed

      let anchor = document.createElement('a');
      anchor.href = window.URL.createObjectURL(blob);
      anchor.download = 'recording.ogx';
      anchor.click();
    };  
  audioRecorder.start();
  
    // Change the button's background color when recording starts
    
  audioRecordingButton.style('background-color', '#FF5733');  // Change to your desired color
}

function stopAudioRecording() {
    if (audioRecorder) {
        audioRecorder.stop();
    }
        // Revert the button's background color when recording stops
    audioRecordingButton.style('background-color', '');  // Removes the inline style, reverting it to its original state or CSS style
  saveLogData();
}

function draw() {
background(92);

  // Display slider values if sliders are not hidden
  if (!slidersHidden) {
    displaySliderValues();
  }

translate(offsetX, offsetY);
scale(zoom);  

 // Only update and display the pendulums if there are any in the array
  if (pendulums.length > 0) {
    for (let pendulum of pendulums) {
      pendulum.update();
      pendulum.display();
      // if (pendulum.isActive) {  // Only call playSound if the pendulum is active
      //   pendulum.playSound();
      // }
    }
  }
}

function displaySliderValues() {

  let angle1 = angle1Slider.value();
  let angle2 = angle2Slider.value();
  let length1 = length1Slider.value();
  let length2 = length2Slider.value();
  let mass1 = mass1Slider.value();
  let mass2 = mass2Slider.value();
  gravity = gravitySlider.value();

  textSize(15);
  fill(0);
  noStroke();
    
  fill(0);
  text("Amplitude: " + amplitudeSlider.value(), 10, 460); // Display amplitude value    
  
  if (slidersHidden) {
    return; // Return immediately if sliders are hidden
  }

// Draw fixed text for control values

  text("Angle 1: " + round(degrees(angle1.toFixed(2))), 10, 20);
  text("Angle 2: " + round(degrees(angle2.toFixed(2))), 10, 60);
  text("Length 1: " + round(length1), 10, 100);
  text("Length 2: " + round(length2), 10, 140);
  text("Mass 1: " + mass1.toFixed(1), 10, 180);
  text("Mass 2: " + mass2.toFixed(1), 10, 220);
  text("Gravity: " + gravity.toFixed(1), 10, 260);  
  fill(255,0,0);
  text("R1: " + round(r1Slider.value()), 10, 300);
  fill(0,0,255);
  text("B1: " + round(b1Slider.value()), 10, 340);
  fill(255,0,0);
  text("R2: " + round(r2Slider.value()), 10, 380);
  fill(0,0,255);
  text("B2: " + round(b2Slider.value()), 10, 420);
}

function addPendulum() {
  if(pendulums.length >= maxPendulums) {
    // pendulums = [];
     pendulums.shift(); // Remove the oldest pendulum from the array
  }
 
  let angle1, angle2, length1, length2, mass1, mass2, r1, b1, r2, b2;
  
  if (slidersHidden) {
    // Randomize slider values if sliders are hidden
    // angle1 = random(0, TWO_PI);
    // angle2 = random(0, TWO_PI);
    angle1 = random((4 * PI) / 3, (2 * PI) / 3);
    angle2 = random((4 * PI) / 3, (2 * PI) / 3);    
    length1 = random(height * 0.15, min(width, height) / 2);
    length2 = random(height * 0.15, min(width, height) / 2);
    mass1 = random(5, 50);
    mass2 = random(5, 50);
    r1 = random(1, 255);
    b1 = random(1, 255);
    r2 = random(1, 255);
    b2 = random(1, 255);
    hideSliders();
  } else {
    // Use slider values if sliders are visible
    angle1 = angle1Slider.value();
    angle2 = angle2Slider.value();
    length1 = length1Slider.value();
    length2 = length2Slider.value();
    mass1 = mass1Slider.value();
    mass2 = mass2Slider.value();
    r1 = r1Slider.value();
    b1 = b1Slider.value();
    r2 = r2Slider.value();
    b2 = b2Slider.value();
  }
  
  let gravity = gravitySlider.value();  
let col1 = color(r1, 0, b1);
let col2 = color(r2, 0, b2);

pendulums.push(new Pendulum(width / 2, height / 2, length1, length2, mass1, mass2, angle1, angle2, col1, col2, gravity));
  
      // Log pendulum parameters
    pendulumLog.push({
        angle1: angle1,
        angle2: angle2,
        length1: length1,
        length2: length2,
        mass1: mass1,
        mass2: mass2,
        r1: r1,
        b1: b1,
        r2: r2,
        b2: b2,
        gravity: gravity,
        areControlsShown: areControlsShown  // new log field
    });
}

function saveLogData() {
    let csvContent = "data:text/csv;charset=utf-8,";
    // CSV header
    csvContent += "angle1,angle2,length1,length2,mass1,mass2,r1,b1,r2,b2,gravity,areControlsShown\n";  // updated header\n";
    pendulumLog.forEach(rowArray => {
        let row = Object.values(rowArray).join(",");
        csvContent += row + "\n";
    });
    let encodedUri = encodeURI(csvContent);
    let link = createA(encodedUri, 'Download Log', '_blank');
    link.download = "pendulum_log.csv";
    link.position(windowWidth - 110, 360); // Adjust position as needed
}

function resetSketch() {
  // pendulums = []; // Clear the array to remove all pendulums
  // Reload the page to reset the sketch
  window.location.reload();  
}

function hideSliders() {
  // Hide GUI sliders
  angle1Slider.hide();
  angle2Slider.hide();
  length1Slider.hide();
  length2Slider.hide();
  mass1Slider.hide();
  mass2Slider.hide();
  gravitySlider.hide();
  r1Slider.hide();
  b1Slider.hide();
  r2Slider.hide();
  b2Slider.hide();
  // amplitudeSlider.hide();

  // Hide text labels
  let textLabels = selectAll('p');
  for (let label of textLabels) {
    if (label.position().y !== 460 && label.position().y !== 500) { // Skip the amplitude and reverb slider text labels
      label.hide();
    }
  }
}

function showSliders() {
  // Hide GUI sliders
  angle1Slider.show();
  angle2Slider.show();
  length1Slider.show();
  length2Slider.show();
  mass1Slider.show();
  mass2Slider.show();
  gravitySlider.show();
  r1Slider.show();
  b1Slider.show();
  r2Slider.show();
  b2Slider.show();
  // amplitudeSlider.show();

  // Hide text labels
  let textLabels = selectAll('p');
  for (let label of textLabels) {
    if (label.position().y !== 460 && label.position().y !== 500) { // Skip the amplitude and reverb slider text labels
      label.show();    }
  }
}

function zoomIn() {
zoom += 0.1;
}

function zoomOut() {
if(zoom > 0.1) {
  zoom -= 0.1;
}
}

function toggleSliders() {
  slidersHidden = !slidersHidden;
  areControlsShown = !slidersHidden;
  if (slidersHidden) {
    hideSliders();
  } else {
    showSliders();
  }
}

function mousePressed() {

  if(mouseX > 200) {
    dragging = true;
  } 
  if (Tone.context.state !== 'running') {
    Tone.context.resume();
  }
}

function mouseReleased() {
dragging = false;
}

function mouseDragged() {
if(dragging) {
  offsetX += mouseX - pmouseX;
  offsetY += mouseY - pmouseY;
}
}

class Arm {
constructor(x, y, length, mass, angle, col, gravity) {
  this.origin = createVector(x, y);
  this.position = createVector();
  this.length = length;
  this.angle = angle;
  this.aVelocity = 0.0;
  this.aAcceleration = 0.0;
  this.mass = mass;
  this.gravity = gravity;
  this.trace = [];
  this.col = col;
}

update() {
  let force = (this.gravity / this.length) * sin(this.angle); 
  this.aAcceleration = -force;
  this.aVelocity += this.aAcceleration;
  this.aVelocity *= 0.99;
  this.angle += this.aVelocity;

  this.position.set(
    this.origin.x + this.length * sin(this.angle),
    this.origin.y + this.length * cos(this.angle)
  );

  this.trace.push(this.position.copy());
  if(this.trace.length > 200) {
    this.trace.shift();
  }
}

display() {
  // Draw arm
  stroke(0); // Black color for the arm
  strokeWeight(2); // Reduced stroke weight
  line(this.origin.x, this.origin.y, this.position.x, this.position.y);

  // Draw bob
  fill(this.col); // Color for the bob
  noStroke(); // No stroke for the bob
  ellipse(this.position.x, this.position.y, this.mass, this.mass);

  // Draw traces as a line instead of points
  strokeWeight(2);
  stroke(this.col); // Color for the traces
  noFill();
  beginShape();
  for(let pos of this.trace) {
    vertex(pos.x, pos.y);
  }
  endShape();
}
}

class Pendulum {
  constructor(
    x,
    y,
    length1,
    length2,
    mass1,
    mass2,
    angle1,
    angle2,
    col1,
    col2,
    gravity
  ) {
    this.arm1 = new Arm(x, y, length1, mass1, angle1, col1, gravity);
    this.arm2 = new Arm(
      this.arm1.position.x,
      this.arm1.position.y,
      length2,
      mass2,
      angle2,
      col2,
      gravity
    );

    // Crie os sintetizadores apenas uma vez
    this.synth1 = new Tone.FMSynth({
      modulationIndex: 12,
      harmonicity: 1,
      modulation: { type: 'sine' },
      modulationEnvelope: {
        attack: 0.5,
        decay: 0.5,
        sustain: 0.7,
        release: 0.5
      },
      envelope: {
        attack: 0.5,
        decay: 0.5,
        sustain: 0.7,
        release: 0.5
      }
    });

    this.synth2 = new Tone.FMSynth({
      modulationIndex: 12,
      harmonicity: 1,
      modulation: { type: 'sine' },
      modulationEnvelope: {
        attack: 0.5,
        decay: 0.5,
        sustain: 0.7,
        release: 0.5
      },
      envelope: {
        attack: 0.5,
        decay: 0.5,
        sustain: 0.7,
        release: 0.5
      }
    });

    // Configure os efeitos
    this.feedbackDelay1 = new Tone.FeedbackDelay({
      delayTime: 0.15,
      feedback: 0.4,
      wet: 0.65
    });

    this.feedbackDelay2 = new Tone.FeedbackDelay({
      delayTime: 0.15,
      feedback: 0.4,
      wet: 0.65
    });

    // Conecte os sintetizadores aos efeitos e Ã  saÃ­da
    this.panner1 = new Tone.Panner(0).toDestination();
    this.panner2 = new Tone.Panner(0).toDestination();

    this.synth1.chain(this.feedbackDelay1, this.panner1);
    this.synth2.chain(this.feedbackDelay2, this.panner2);

    // Inicie os sintetizadores
    this.synth1.triggerAttack('C4');
    this.synth2.triggerAttack('C4');

    this.isActive = true;
    this.startTime = millis();
  }

  update() {
    this.arm1.update();
    this.arm2.origin = this.arm1.position.copy();
    this.arm2.update();

    // Atualiza os parÃ¢metros do som
    this.updateSound();

    // Verifica se o pÃªndulo deve ser removido
    let velocityThreshold = 0.01;
    let nestedVelocity = p5.Vector.add(
      this.arm1.position,
      this.arm2.position
    ).mag();

    if (nestedVelocity < velocityThreshold || millis() - this.startTime > 10000) {
      this.remove();
    }
  }

  updateSound() {
    let amplitude = amplitudeSlider.value();

    // Calcule as frequÃªncias baseadas nas propriedades do pÃªndulo
    let freq1 = map(this.arm1.mass, 5, 50, 200, 1000);
    let freq2 = map(this.arm2.mass, 5, 50, 200, 1000);

    // Atualize a frequÃªncia dos sintetizadores suavemente
    this.synth1.frequency.rampTo(freq1, 0.1);
    this.synth2.frequency.rampTo(freq2, 0.1);

    // Atualize a amplitude (volume) suavemente
    this.synth1.volume.rampTo(Tone.gainToDb(amplitude), 0.1);
    this.synth2.volume.rampTo(Tone.gainToDb(amplitude), 0.1);

    // Constranja a posiÃ§Ã£o x para estar dentro do intervalo [0, width]
    let x1 = constrain(this.arm1.position.x, 0, width);
    let x2 = constrain(this.arm2.position.x, 0, width);

    // Atualize a posiÃ§Ã£o do pan (estÃ©reo)
    let panPosition1 = map(x1, 0, width, -1, 1);
    let panPosition2 = map(x2, 0, width, -1, 1);

    // Constranja o valor de panPosition para estar entre -1 e 1
    panPosition1 = constrain(panPosition1, -1, 1);
    panPosition2 = constrain(panPosition2, -1, 1);

    this.panner1.pan.rampTo(panPosition1, 0.1);
    this.panner2.pan.rampTo(panPosition2, 0.1);

    // Atualize outros parÃ¢metros se necessÃ¡rio
    let modulationFrequency1 = map(r1Slider.value(), 1, 255, 1, 1000);
    this.synth1.harmonicity.rampTo(modulationFrequency1, 0.1);

    let modulationDepth1 = map(b1Slider.value(), 1, 255, 1, 10);
    this.synth1.modulationIndex.rampTo(modulationDepth1, 0.1);

    let modulationFrequency2 = map(r2Slider.value(), 1, 255, 1, 1000);
    this.synth2.harmonicity.rampTo(modulationFrequency2, 0.1);

    let modulationDepth2 = map(b2Slider.value(), 1, 255, 1, 10);
    this.synth2.modulationIndex.rampTo(modulationDepth2, 0.1);
  }

  remove() {
    // Pare os sintetizadores
    this.synth1.triggerRelease();
    this.synth2.triggerRelease();

    // Remova o pÃªndulo da lista
    pendulums.splice(pendulums.indexOf(this), 1);
    this.isActive = false;
  }

  display() {
    this.arm1.display();
    this.arm2.display();
  }
}
